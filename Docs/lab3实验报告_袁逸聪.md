# 袁逸聪 lab3实验报告

袁逸聪 19302010020

## 负责任务

1. 后端预约、借书模块开发
2. 后端单元测试开发
3. 前后端对接调试
4. 后端Token机制实现
5. 后端图片存储方案实现

## 新增模块开发

开发结束后往回看，新增模块在实现功能不难，但开发过程中的效率并不高。我认为核心原因在于沟通与设计的减少。相比于Lab2，本次Lab中出现了更多接口随做随改、前后端更改接口后却相互不知晓的情况。完美的顶层设计不太可能，但实现代码前的设计过程应由所由所有成员参与并知晓。

## 后端单元测试

单元测试先前的阻力在于没有独立的数据库，即便有@Transactional注解，让测试的过程不影响生产环境数据库，在测试时也不能保证数据库的状态如开发者所预期，进而无法给出可靠的assert。

不过通过spring.profiles.active的机制，目前在单源测试时将启用独立的内存h2数据库，与开发生产使用的mysql完全区分。

单源测试不仅仅是事后的检验，也可以在实现之前给出比文档更明确的需求。在Lab4中可能会尝试接口→单元测试→实现，面向测试实现的开发路径。

## 前后端对接调试

即便有接口的约束，对接调试仍不可避免。譬如缺少了@JsonProperty注解导致看似完全一致的key接受不到对应参数，在前后端分离的开发中很难想到。由于这些不确定性的存在，大家往往也更愿意在自己独立可知可测的范围内进行开发。

或许，在积累一定经验后，对前后端可能存在的对接问题如请求content-type、是否使用FormData()、如何靠注解接受参数、用什么风格命名参数等，都要以代码风格式的方案给出明确要求。

## 后端Token机制实现

Lab2中的用户检测完全基于前端的页面展示，在Lab3中新增了后端的要求。每一个需要权限的接口都需要临时产生的token才能成功调用。

我认为开发的过程中应当随着需求，尽可能选择轻量级的方式——即原理与实现尽可能为自己所知的方式去完成功能。这既是为了开发上的快捷与不浪费，也是在要求处在真实的场景中，明白每一个“变重”的组件为什么要“变重”，而不是能开炮却只用来打蚊子。

本次Lab的token是为了在需要权限的请求中验明来者身份，但又不方便每次都传输账号与密码。于是根据登录时的用户信息哈希生成token，并将<token,user>的键值关系存储在服务器上。请求只需要带着正确的token参数，就能让服务器检验其身份。并且token中不包含任何敏感的用户信息。(尽管在token若在有效期内泄露，有被冒用账号的可能，但临时的token还是比暴露密码安全得多)

## 图片存储方案实现

Lab2中由于不需要打包部署，图片文件可以简单运用File存储在springboot的static目录下。而部署时将springboot打成jar包，jar包内部是无法实时修改的，所以Lab3必须寻找替代方案。

最终选择在jar包的同级目录下放置新的static资源，并将此目录映射到后端开放端口下。

```Java
@Configuration
public class StaticConfigurerAdapter implements WebMvcConfigurer {
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/**")
                .addResourceLocations("file:此处填写资源文件夹的目录");
    }
}
```

添加如上类，springboot项目将在启动时载入此配置，完成映射。于是可以直接以 **{ip}:port/XXX** 的形式获取形如 **[资源目录]/XXX** 的文件(在本项目中即是图片了)

## 整体心得

预约、借书模块的新增功能，比Lab2更加复杂，但在技术上并没有新的难点。比起Lab3中的实现，新功能引出的更大问题是：一个数据对象(比如一条借书记录)并不仅仅使用其表内数据，还不可避免地需要用到用户、副本的数据库。

面对Lab4中要求的微服务化，这种共用就成了很大的阻力。作为接口合法性验证的调用并不足以支撑起一次服务间通信的需求——更何况，新的服务间通信可能又要有新的合法性验证。共用数据库将性能的瓶颈落在了单独的数据库服务上，而复制部分其他表中数据的方案则对不同服务间的数据同步提出挑战。